<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROOM_2 Smart Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
  body {
    margin:0; padding:0; 
    font-family: "Inter", sans-serif;
    background:#0f172a; /* Slate 900 */
    color:#e2e8f0; /* Slate 200 */
    line-height:1.4;
    font-size: 0.95rem; 
  }

  /* Global Container for Dashboard Content */
  #dashboardContainer {
    padding: 10px;
  }

  /* --- LOGIN SCREEN STYLES --- */
  #loginScreen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
    text-align: center;
    background: #1e293b; 
  }
  .login-card {
    background: #0f172a;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    max-width: 350px;
    width: 100%;
  }
  .login-card h2 {
    color: #38bdf8;
    margin-bottom: 20px;
    font-size: 1.8rem;
  }
  .login-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid #334155;
    border-radius: 6px;
    background: #1e293b;
    color: #f1f5f9;
    font-size: 1rem;
    box-sizing: border-box;
  }
  .login-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 6px;
    background: #10b981;
    color: #042f2e;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .login-btn:hover { background: #059669; }
  #loginError {
    color: #ef4444;
    margin-top: 10px;
    font-size: 0.85rem;
  }

  /* --- HEADER AND PROFILE MENU STYLES --- */
  header {
    display: grid;
    /* 3-column layout: Left Spacer | Centered Content | Right Button */
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    margin-bottom: 12px;
    padding: 0 5px; 
    position: relative; 
  }
  header h1 {
    color:#38bdf8; 
    margin:0; 
    font-size:1.6rem; 
  }
  .header-center-content {
      display: flex;
      flex-direction: column;
      align-items: center; /* Centers items horizontally */
      grid-column: 2; /* Ensures this content sits in the middle column */
  }
  .profile-menu {
    grid-column: 3; /* Ensures menu is in the right column */
    justify-self: end; /* Pushes the menu to the far right */
    position: relative;
    z-index: 10;
  }
  .profile-btn {
    background: transparent;
    border: none;
    color: #38bdf8;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
  }
  .dropdown-content {
    display: none;
    position: absolute;
    top: 100%; 
    right: 0;
    background-color: #1e293b;
    min-width: 180px;
    box-shadow: 0 8px 16px 0 rgba(0,0,0,0.4);
    border-radius: 8px;
    z-index: 1;
    padding: 10px;
    border: 1px solid #334155;
    text-align: left;
  }
  .dropdown-content.show {
    display: block;
  }
  .dropdown-content p {
    margin: 0 0 10px 0;
    color: #94a3b8;
    font-size: 0.85rem;
    word-break: break-word;
  }
  .logout-btn {
    width: 100%;
    padding: 8px;
    border: none;
    border-radius: 6px;
    background: #ef4444;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.2s;
  }
  .logout-btn:hover { background: #b91c1c; }


  /* --- DASHBOARD ELEMENTS --- */
  .tabs { display:flex; gap:6px; margin-top:6px; }
  .tab-btn { 
    padding:6px 12px; 
    border:none; 
    border-radius:6px; 
    background:#1e293b; 
    color:#94a3b8; 
    cursor:pointer; 
    font-weight:600; 
    transition: background 0.2s, color 0.2s;
    font-size:0.8rem; 
  }
  .tab-btn:hover { background:#334155; }
  .tab-btn.active { 
    background:#10b981; 
    color:#042f2e; 
  }
  .tab-content { display:none; padding-top: 6px; }
  .tab-content.active { display:block; }
  
  /* Status styles now handle three colors */
  .status { 
    display:inline-block; 
    padding:4px 10px; 
    border-radius:16px; 
    background:#ef4444; /* Default: Device Offline (Red) */
    color:#fff; 
    font-weight:600; 
    font-size:0.75rem; 
    margin-top:10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: background 0.3s;
  }
  .status.online { background:#10b981; } /* Device Online (Green) */

  .info-main { 
    display:grid; 
    grid-template-columns: 1fr 1fr; 
    gap:8px; 
    margin-bottom:12px; 
  }
  .panel { 
    background: rgba(30,41,59,0.9); 
    border-radius:10px; 
    padding:10px; 
    text-align:center; 
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
    border: 1px solid #334155;
  }
  .panel .label { 
    font-size:0.65rem; 
    color:#94a3b8; 
    margin-bottom:2px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .panel .value { 
    font-weight:700; 
    font-size:1rem; 
    color:#f1f5f9; 
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .relays { 
    display:flex; 
    justify-content:center; 
    gap:16px; 
    flex-wrap:wrap; 
    margin-bottom:20px; 
    padding: 6px 0;
  }
  .relay-btn { 
    width:65px; 
    height:65px; 
    border-radius:50%; 
    border:3px solid #475569; 
    display:flex; 
    flex-direction: column;
    justify-content:center; 
    align-items:center; 
    background:#1e293b; 
    color:#94a3b8; 
    font-weight:600; 
    font-size:0.85rem;
    cursor:pointer; 
    transition:0.3s; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  }
  .relay-btn.on { 
    background:#10b981; 
    border-color:#34d399; 
    color:#042f2e; 
    box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
  }

  /* Automation Centering */
  .automation-content-wrapper {
    max-width: 400px; 
    margin: 0 auto; 
  }

  .automation-switch { 
    display:flex; 
    align-items:center; 
    gap:10px; 
    margin-bottom:20px; 
    cursor:pointer; 
    font-weight:600; 
    justify-content:center; 
    font-size:1rem;
    color:#94a3b8;
  }
  .automation-switch.on span { color: #f1f5f9; }
  .switch-btn { 
    width:44px; 
    height:22px; 
    border-radius:11px; 
    background:#ef4444; 
    position:relative; 
    transition:0.2s;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
  }
  .switch-btn.on { background:#10b981; }
  .switch-btn::after { 
    content:''; 
    position:absolute; 
    top:2px; 
    left:2px; 
    width:18px; 
    height:18px; 
    border-radius:50%; 
    background:#fff; 
    transition:0.2s; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
  }
  .switch-btn.on::after { transform:translateX(22px); }

  .automation-relays-container {
    display:flex; 
    flex-direction:column; 
    gap:10px;
  }
  .automation-panel { 
    padding: 12px;
    border-radius: 10px;
    background: rgba(30,41,59,0.9);
    border: 1px solid #334155;
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
  }
  .automation-panel > div:first-child {
    font-weight:800; 
    margin-bottom:8px; 
    color: #38bdf8;
    font-size: 1.1rem;
    text-align: center;
  }
  .offset-group-inline {
    display:flex; 
    gap:12px; 
    align-items:center; 
    justify-content:flex-start; 
    flex-wrap: wrap;
    font-size: 0.85rem;
  }
  .offset-group-inline input { 
    width:50px; 
    text-align:center; 
    border-radius:6px; 
    border:1px solid #475569; 
    background:#1e293b; 
    color:#fff; 
    padding:4px; 
    margin-left:4px; 
    font-size: 0.9rem;
  }
  .offset-group-inline label {
    display: flex;
    align-items: center;
  }

  .log-viewer {
    height: 350px; 
    overflow-y: scroll;
    background: #1e293b;
    border-radius: 8px;
    padding: 8px;
    border: 1px solid #334155;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.8rem; 
    color: #cbd5e1;
  }
  .log-entry {
    border-bottom: 1px dotted #334155;
    padding: 3px 0;
  }
  .log-entry:last-child { border-bottom: none; }
  .log-entry-time {
    color: #94a3b8;
    margin-right: 6px;
  }
  .log-entry-type-info { color: #38bdf8; }
  .log-entry-type-warn { color: #fbbf24; }
  .log-entry-type-error { color: #ef4444; }
  .log-entry-type-relay { color: #10b981; }

</style>
</head>
<body>

<div id="loginScreen" style="display: none;">
  <div class="login-card">
    <h2>ROOM_2 Login</h2>
    <input type="email" id="loginEmail" class="login-input" placeholder="Email">
    <input type="password" id="loginPassword" class="login-input" placeholder="Password">
    <button id="loginBtn" class="login-btn">Sign In</button>
    <div id="loginError"></div>
    <button id="createAccountBtn" class="login-btn" style="margin-top: 10px; background: #94a3b8;">Create Account (New User)</button>
  </div>
</div>

<div id="dashboardContainer" style="display: none;">
  <header>
    <div></div> 

    <div class="header-center-content">
      <h1>ROOM_2 Dashboard</h1>
      <div class="tabs">
        <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="automation">Automation</button>
        <button class="tab-btn" data-tab="stats">Stats</button>
        <button class="tab-btn" data-tab="logs">Logs</button>
      </div>
      <div id="status" class="status">Offline</div>
      <div id="versionInfo" style="font-size: 0.7rem; color: #94a3b8; margin-top: 5px;"></div>
    </div>
    
    <div class="profile-menu">
        <button class="profile-btn" id="profileBtn">â‹®</button>
        <div class="dropdown-content" id="profileDropdown">
            <p>Logged in as:</p>
            <p id="userEmailDisplay">user@example.com</p>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>
  </header>

  <div id="dashboard" class="tab-content active">
    <div class="info-main">
      <div class="panel"><div class="label">IP</div><div id="ip" class="value">--</div></div>
      <div class="panel"><div class="label">MAC</div><div id="mac" class="value">--</div></div>
      <div class="panel"><div class="label">SSID</div><div id="ssid" class="value">--</div></div>
      <div class="panel"><div class="label">Uptime</div><div id="uptime" class="value">--</div></div>
      <div class="panel"><div class="label">SunRise</div><div id="sunrise" class="value">--:--</div></div>
      <div class="panel"><div class="label">SunSet</div><div id="sunset" class="value">--:--</div></div>
    </div>

    <div class="relays">
      <div id="r1" class="relay-btn">FAN</div>
      <div id="r2" class="relay-btn">LIGHT</div>
      <div id="r3" class="relay-btn">FAN-2</div>
      <div id="r4" class="relay-btn">DIM-L</div>
    </div>

    <footer class="info-main">
      <div class="panel"><div class="label">Last Update (Human)</div><div id="lastUpdateHuman" class="value">--:--</div></div>
      <div class="panel"><div class="label">Last Update (Timestamp)</div><div id="lastUpdate" class="value">--:--</div></div>
    </footer>
  </div>

  <div id="automation" class="tab-content">
    <div class="automation-content-wrapper">
      <div class="automation-switch">
        <span>Automation Schedule</span>
        <div id="automationSwitch" class="switch-btn"></div>
      </div>

      <div class="automation-relays-container">
        <div class="automation-panel">
          <div>Relay 1 (FAN)</div>
          <div class="offset-group-inline">
            <label>Sunrise (min): <input type="number" id="r1_sunrise" min="-60" max="60" step="1" value="0"></label>
            <label>Sunset (min): <input type="number" id="r1_sunset" min="-60" max="60" step="1" value="0"></label>
          </div>
        </div>

        <div class="automation-panel">
          <div>Relay 2 (LIGHT)</div>
          <div class="offset-group-inline">
            <label>Sunrise (min): <input type="number" id="r2_sunrise" min="-60" max="60" step="1" value="0"></label>
            <label>Sunset (min): <input type="number" id="r2_sunset" min="-60" max="60" step="1" value="0"></label>
          </div>
        </div>

        <div class="automation-panel">
          <div>Relay 3 (FAN-2)</div>
          <div class="offset-group-inline">
            <label>Sunrise (min): <input type="number" id="r3_sunrise" min="-60" max="60" step="1" value="0"></label>
            <label>Sunset (min): <input type="number" id="r3_sunset" min="-60" max="60" step="1" value="0"></label>
          </div>
        </div>

        <div class="automation-panel">
          <div>Relay 4 (DIM-L)</div>
          <div class="offset-group-inline">
            <label>Sunrise (min): <input type="number" id="r4_sunrise" min="-60" max="60" step="1" value="0"></label>
            <label>Sunset (min): <input type="number" id="r4_sunset" min="-60" max="60" step="1" value="0"></label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="stats" class="tab-content">
    <div class="info-main">
      <div class="panel">
        <div class="label">Online Duration (Today)</div>
        <div id="onlineDuration" class="value">--</div>
      </div>
      <div class="panel">
        <div class="label">Offline Duration (Today)</div>
        <div id="offlineDuration" class="value">--</div>
      </div>
      <div class="panel">
        <div class="label">Daily Uptime (%)</div>
        <div id="uptimePercent" class="value">--</div>
      </div>
      <div class="panel">
        <div class="label">Last Disconnect</div>
        <div id="lastDisconnect" class="value">--</div>
      </div>
    </div>
  </div>

  <div id="logs" class="tab-content">
    <div class="log-viewer" id="logViewer">
      <div class="log-entry"><span class="log-entry-time">--:--:--</span><span class="log-entry-type-info">INFO:</span> Client-side log initialized.</div>
    </div>
  </div>
</div>


<script type="module">
// --- FIREBASE IMPORTS ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAei8j8RQXq_zspkohtH40g_gvHUfIx-Uw",
  authDomain: "home-control-df716.firebaseapp.com",
  databaseURL: "https://home-control-df716-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "home-control-df716",
  storageBucket: "home-control-df716.firebasestorage.app",
  messagingSenderId: "956714070689",
  appId: "1:956714070689:web:414179e22a04601349b6e0",
  measurementId: "G-LEHP8KM47D"
};

// Initialize Firebase services
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);


// --- GLOBAL STATE & UI ELEMENTS ---
const SESSION_KEY = 'room2_session_active';
const DASHBOARD_VERSION = 'v1.3.1'; 

const loginScreen = document.getElementById('loginScreen');
const dashboardContainer = document.getElementById('dashboardContainer');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');
const createAccountBtn = document.getElementById('createAccountBtn');
const loginError = document.getElementById('loginError');
const profileBtn = document.getElementById('profileBtn');
const profileDropdown = document.getElementById('profileDropdown');
const userEmailDisplay = document.getElementById('userEmailDisplay');
const logoutBtn = document.getElementById('logoutBtn');

const statusEl = document.getElementById('status');
const versionInfoEl = document.getElementById('versionInfo');
const uptimeEl = document.getElementById('uptime');
const lastDisconnectEl = document.getElementById('lastDisconnect');
const logViewer = document.getElementById('logViewer');
const relayBtns = [document.getElementById('r1'),document.getElementById('r2'),document.getElementById('r3'),document.getElementById('r4')];

// Internal State for Connection Management
let lastHeartbeatTime = null; 
let deviceOnline = false;     
let clientConnected = false;  

// Client Stats
let lastDisconnectTimestamp = null; 
let totalOnlineSeconds = 0;
let totalOfflineSeconds = 0;
let lastStateChangeTime = Date.now(); 


// --- UTILITIES & DASHBOARD LOGIC ---

// Dhaka Time Options for robust time zone handling (fixes time offset issue)
const DHAKA_OPTIONS = { 
  hour: '2-digit', 
  minute: '2-digit', 
  second: '2-digit',
  hour12: true, 
  timeZone: 'Asia/Dhaka' 
};

function formatTime(timestamp) {
  if (!timestamp) return '--:--:--';
  const d = new Date(timestamp);
  return d.toLocaleTimeString('en-US', DHAKA_OPTIONS);
}

function addLogEntry(type, message) {
    const time = new Date().toLocaleTimeString('en-US', DHAKA_OPTIONS);
    const typeClass = `log-entry-type-${type.toLowerCase()}`;
    
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `<span class="log-entry-time">${time}</span><span class="${typeClass}">${type}:</span> ${message}`;

    logViewer.prepend(entry);
    while (logViewer.children.length > 50) {
        logViewer.removeChild(logViewer.lastChild);
    }
}

// Set version on load
versionInfoEl.textContent = `Dashboard Version: ${DASHBOARD_VERSION}`;


// --- AUTHENTICATION & SESSION LOGIC ---
function showLogin() {
    dashboardContainer.style.display = 'none';
    loginScreen.style.display = 'flex';
}

function showDashboard(user) {
    localStorage.setItem(SESSION_KEY, 'true');
    userEmailDisplay.textContent = user.email;
    loginScreen.style.display = 'none';
    dashboardContainer.style.display = 'block';
    // NEW: Store dashboard version in Firebase RTDB
    if (user && db) {
        set(ref(db, 'HOME/ROOM_2/version'), DASHBOARD_VERSION); 
        addLogEntry('INFO', `Dashboard version ${DASHBOARD_VERSION} logged to RTDB.`);
    }
}

function handleAuthError(error) {
    loginError.textContent = error.message.replace('Firebase: ', '');
    addLogEntry('ERROR', `Authentication failed: ${error.code}`);
}

if (localStorage.getItem(SESSION_KEY) === 'true') {
    showDashboard({ email: 'Checking session...' }); 
} else {
    showLogin();
}

onAuthStateChanged(auth, (user) => {
    if (user) {
        showDashboard(user);
        addLogEntry('INFO', `User ${user.email} signed in successfully.`);
    } else {
        if (localStorage.getItem(SESSION_KEY) === 'true') {
            localStorage.removeItem(SESSION_KEY);
            addLogEntry('WARN', 'Device session expired. Please log in again.');
        }
        showLogin();
    }
});

loginBtn.addEventListener('click', async () => {
    loginError.textContent = '';
    try {
        await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
    } catch (error) {
        handleAuthError(error);
    }
});

createAccountBtn.addEventListener('click', async () => {
    loginError.textContent = '';
    if (!loginEmail.value || !loginPassword.value) {
        loginError.textContent = 'Please enter both email and password.';
        return;
    }
    try {
        await createUserWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
    } catch (error) {
        handleAuthError(error);
    }
});

logoutBtn.addEventListener('click', async () => {
    try {
        await signOut(auth);
        localStorage.removeItem(SESSION_KEY); 
        addLogEntry('INFO', 'User logged out.');
    } catch (error) {
        handleAuthError(error);
    }
});

document.getElementById('profileBtn').addEventListener('click', () => {
    profileDropdown.classList.toggle('show');
});
window.addEventListener('click', (event) => {
    if (!event.target.matches('#profileBtn') && !event.target.closest('.dropdown-content')) {
        if (profileDropdown.classList.contains('show')) {
            profileDropdown.classList.remove('show');
        }
    }
});


// --- STATUS DISPLAY LOGIC ---

function writeOnlineFlag(state){set(ref(db,'HOME/ROOM_2/online'),!!state);}

function updateStatusDisplay() {
    statusEl.classList.remove('online');
    statusEl.style.color = '#fff';
    
    if (!clientConnected) {
        statusEl.textContent = "Client Disconnected";
        statusEl.style.backgroundColor = '#fbbf24'; // Amber (Client is the problem)
        statusEl.style.color = '#0f172a'; // Dark text for contrast
    } else if (deviceOnline) {
        statusEl.textContent = "Online";
        statusEl.style.backgroundColor = ''; // Reset inline style
        statusEl.classList.add('online'); // Green (Everything is good)
    } else {
        statusEl.textContent = "Offline";
        statusEl.style.backgroundColor = '#ef4444'; // Red (Device is the problem)
    }
}

// 1. Client Connection Listener: Monitors browser/network connection to Firebase
onValue(ref(db, '.info/connected'), (snap) => {
    const wasConnected = clientConnected;
    clientConnected = snap.val();
    
    if (clientConnected && !wasConnected) {
        addLogEntry('INFO', 'Client reconnected to Firebase.');
    } else if (!clientConnected && wasConnected) {
        addLogEntry('ERROR', 'Client lost connection to Firebase. Relays cannot be toggled.');
    }
    updateStatusDisplay();
});


// --- DASHBOARD AND RELAY LOGIC ---

// Tabs
const tabs = document.querySelectorAll('.tab-btn');
const contents = document.querySelectorAll('.tab-content');
tabs.forEach(btn=>{
  btn.addEventListener('click',()=>{
    tabs.forEach(b=>b.classList.remove('active'));
    contents.forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// Relays
function setRelayState(btn,on){ if(on) btn.classList.add('on'); else btn.classList.remove('on'); }

function toggleRelay(index){ 
    // IMPORTANT: Check client connection before attempting a write operation
    if (!clientConnected) {
        addLogEntry('ERROR', 'Cannot toggle relay: Client disconnected from Firebase.');
        alert('Cannot toggle relay: Dashboard is disconnected from the network/Firebase.');
        return;
    }

    const path=`HOME/ROOM_2/relay${index+1}`; 
    get(ref(db,path)).then(snap=>{
        const newState = !snap.val();
        // Since client is connected, we can send the command
        set(ref(db,path), newState); 
        const relayName = relayBtns[index].textContent;
        const stateStr = newState ? 'ON' : 'OFF';
        addLogEntry('RELAY', `${relayName} manually set to ${stateStr}`); 
    }).catch(error => {
        addLogEntry('ERROR', `Failed to read/write relay state: ${error.message}`);
    });
}
relayBtns.forEach((btn,i)=>{ 
    btn.addEventListener('click',()=>toggleRelay(i)); 
    onValue(ref(db,`HOME/ROOM_2/relay${i+1}`),snap=>setRelayState(btn,!!snap.val())); 
});

// Device Info (Firebase bindings)
const ipEl = document.getElementById('ip');
const macEl = document.getElementById('mac');
const ssidEl = document.getElementById('ssid');
const sunriseEl = document.getElementById('sunrise');
const sunsetEl = document.getElementById('sunset');
const lastUpdateHumanEl = document.getElementById('lastUpdateHuman');
const lastUpdateEl = document.getElementById('lastUpdate');
onValue(ref(db,'HOME/ROOM_2/device/ip'),s=>ipEl.textContent=s.val()||'--');
onValue(ref(db,'HOME/ROOM_2/device/mac'),s=>macEl.textContent=s.val()||'--');
onValue(ref(db,'HOME/ROOM_2/device/ssid'),s=>ssidEl.textContent=s.val()||'--');
onValue(ref(db,'HOME/ROOM_2/uptime'),s=>uptimeEl.textContent=s.val()||'--');
onValue(ref(db,'HOME/ROOM_2/sunrise'),s=>sunriseEl.textContent=s.val()||'--:--');
onValue(ref(db,'HOME/ROOM_2/sunset'),s=>sunsetEl.textContent=s.val()||'--:--');
onValue(ref(db,'HOME/ROOM_2/lastUpdateHuman'),s=>lastUpdateHumanEl.textContent=s.val()||'--:--');
onValue(ref(db,'HOME/ROOM_2/lastUpdate'),s=>{
    lastUpdateEl.textContent=s.val() ? formatTime(s.val()) : '--:--';
});


// 2. Device Heartbeat Listener (Resets timer)
onValue(ref(db,'HOME/ROOM_2/uptime'),snap=>{
  const val=snap.val(); 
  if(val===null||val===undefined) return; 
  
  uptimeEl.textContent=val;

  lastHeartbeatTime = Date.now(); 
  
  if(!deviceOnline){ 
    deviceOnline = true; 
    updateStatusDisplay(); 
    writeOnlineFlag(true); 
    addLogEntry('INFO', 'Device heartbeat received. Status: ONLINE.'); 
  }
});


// 3. Status Interval (Checks Timer and Updates State)
function updateStats(){
    const now = Date.now();
    const elapsedSeconds = (now - lastStateChangeTime) / 1000;
    
    // Only accumulate stats if we are sure the client is connected
    if (clientConnected) {
        if (deviceOnline) {
            totalOnlineSeconds += elapsedSeconds;
        } else {
            totalOfflineSeconds += elapsedSeconds;
        }
    }

    lastStateChangeTime = now;
    const totalSeconds = totalOnlineSeconds + totalOfflineSeconds;
    const uptimePercentEl = document.getElementById('uptimePercent');
    const onlineDurationEl = document.getElementById('onlineDuration');
    const offlineDurationEl = document.getElementById('offlineDuration');
    const uptimePercent = totalSeconds > 0 ? ((totalOnlineSeconds / totalSeconds) * 100).toFixed(2) : '0.00';

    const formatDuration = (seconds) => {
        if (seconds < 0) return '--';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return `${h}h ${m}m ${s.toFixed(0)}s`;
    };

    onlineDurationEl.textContent = formatDuration(totalOnlineSeconds);
    offlineDurationEl.textContent = formatDuration(totalOfflineSeconds);
    uptimePercentEl.textContent = `${uptimePercent}%`;
}


setInterval(()=>{
  if(!lastHeartbeatTime) { updateStats(); return; }
  const elapsed=(Date.now()-lastHeartbeatTime)/1000;
  
  // Timeout set to 45 seconds
  const OFFLINE_TIMEOUT = 45; 

  if(elapsed > OFFLINE_TIMEOUT && deviceOnline){ 
    deviceOnline = false; 
    updateStatusDisplay(); 
    writeOnlineFlag(false); 
    lastDisconnectTimestamp = Date.now();
    lastDisconnectEl.textContent = formatTime(lastDisconnectTimestamp);
    addLogEntry('WARN', `Device status changed to OFFLINE (Timeout: ${OFFLINE_TIMEOUT}s).`); 
  }
  
  updateStats();
  updateStatusDisplay(); // Always update display in case clientConnected changed
},1000);


// Automation Switch and Offset Inputs
const automationSwitch = document.getElementById('automationSwitch');
const offsetInputs = [
  {sunrise: document.getElementById('r1_sunrise'), sunset: document.getElementById('r1_sunset')},
  {sunrise: document.getElementById('r2_sunrise'), sunset: document.getElementById('r2_sunset')},
  {sunrise: document.getElementById('r3_sunrise'), sunset: document.getElementById('r3_sunset')},
  {sunrise: document.getElementById('r4_sunrise'), sunset: document.getElementById('r4_sunset')}
];

onValue(ref(db,'HOME/ROOM_2/settings/scheduleEnabled'),snap=>{
  const val=snap.val();
  const stateStr = val ? 'Enabled' : 'Disabled';
  if (automationSwitch.classList.contains('on') !== !!val) { 
      addLogEntry('INFO', `Automation schedule set to ${stateStr}.`); 
  }
  if(val) automationSwitch.classList.add('on'); else automationSwitch.classList.remove('on');
  automationSwitch.parentNode.classList.toggle('on', !!val); 
});
automationSwitch.addEventListener('click',()=>{
  if (!clientConnected) {
      alert('Cannot change settings: Dashboard is disconnected.');
      return;
  }
  const newVal=!automationSwitch.classList.contains('on');
  set(ref(db,'HOME/ROOM_2/settings/scheduleEnabled'), newVal);
});

offsetInputs.forEach((obj,i)=>{
  const pathPrefix = `HOME/ROOM_2/settings/relay${i+1}/`;
  const relayName = relayBtns[i].textContent;

  onValue(ref(db,pathPrefix + 'sunriseOffset'),snap=>obj.sunrise.value=snap.val()||0);
  onValue(ref(db,pathPrefix + 'sunsetOffset'),snap=>obj.sunset.value=snap.val()||0);
  
  const handleOffsetChange = (input, offsetType) => {
      if (!clientConnected) {
          alert('Cannot change settings: Dashboard is disconnected.');
          return;
      }
      const val = Number(input.value);
      set(ref(db,pathPrefix + offsetType + 'Offset'), val);
      addLogEntry('INFO', `${relayName} ${offsetType} Offset set to ${val} min.`); 
  };

  obj.sunrise.addEventListener('change',()=>handleOffsetChange(obj.sunrise, 'sunrise'));
  obj.sunset.addEventListener('change',()=>handleOffsetChange(obj.sunset, 'sunset'));
});
</script>

</body>
</html>
